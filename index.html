<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lançador de Chats - Kick</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #ffffff; margin: 0; padding: 20px; font-size: 16px; overflow: hidden; }
        .container { max-width: 600px; margin: 0 auto; }
        #main-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        #streamerInput { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #333; background-color: #222; color: #fff; }
        #addChatBtn { padding: 10px 15px; border: none; color: #111; background-color: #00ff7f; font-weight: bold; border-radius: 5px; cursor: pointer; }
        #counter-display { font-size: 1.1em; color: #aaa; font-weight: bold; margin-left: auto; white-space: nowrap; }
        #completed-count { color: #ffae42; }
        #channel-display { position: relative; height: 120px; margin-top: 30px; display: flex; align-items: center; justify-content: center; }
        .channel-card { background-color: #1f1f1f; border: 1px solid #444; border-left: 4px solid #00ff7f; border-radius: 8px; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; width: 100%; box-sizing: border-box; animation: fadeIn 0.5s ease; }
        .channel-name { font-weight: bold; font-size: 1.5em; color: #eee; }
        .launch-btn { background-color: #00ff7f; color: #111; border: none; padding: 12px 18px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; }
        #next-channel-btn { background-color: #7f7fff; color: #111; border: none; padding: 15px 25px; font-size: 1.2em; border-radius: 8px; cursor: pointer; }
        #next-channel-btn:disabled { background-color: #333; color: #777; cursor: not-allowed; }
        #status-message { text-align: center; color: #777; font-style: italic; padding: 20px; min-height: 24px; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div class="container">
        <div id="main-controls">
            <input type="text" id="streamerInput" placeholder="Adicionar canal à lista...">
            <button id="addChatBtn">Adicionar</button>
            <div id="counter-display">Concluídos: <span id="completed-count">0</span></div>
        </div>
        <div id="channel-display">
             <button id="next-channel-btn">Buscar Próximo Online</button>
        </div>
        <p id="status-message"></p>
    </div>

    <script>
        const streamerInput = document.getElementById('streamerInput');
        const addChatBtn = document.getElementById('addChatBtn');
        const nextChannelBtn = document.getElementById('next-channel-btn');
        const channelDisplay = document.getElementById('channel-display');
        const statusMessage = document.getElementById('status-message');
        const completedCountSpan = document.getElementById('completed-count');

        let masterChannelList = [];
        let currentIndex = 0;

        function getOpenedChannels() { return new Set(JSON.parse(localStorage.getItem('openedKickChannels')) || []); }
        function addChannelToOpened(channelName) {
            const opened = getOpenedChannels();
            opened.add(channelName);
            localStorage.setItem('openedKickChannels', JSON.stringify(Array.from(opened)));
        }
        function updateCompletedCounter() { completedCountSpan.textContent = getOpenedChannels().size; }

        async function findNextOnline() {
            nextChannelBtn.disabled = true;
            nextChannelBtn.textContent = 'Buscando...';
            channelDisplay.innerHTML = '';
            statusMessage.textContent = `Verificando a partir do canal ${currentIndex + 1}...`;

            const openedChannels = getOpenedChannels();
            
            while(currentIndex < masterChannelList.length) {
                const channelName = masterChannelList[currentIndex];
                statusMessage.textContent = `Verificando ${currentIndex + 1}/${masterChannelList.length}: ${channelName}`;

                if (openedChannels.has(channelName)) {
                    currentIndex++;
                    continue; // Pula se já foi aberto
                }
                
                try {
                    const response = await fetch('/api/status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ channel: channelName })
                    });
                    const data = await response.json();
                    if (data.is_live) {
                        createLauncherElement(channelName);
                        statusMessage.textContent = `Encontrado!`;
                        nextChannelBtn.disabled = true; // Desabilita o botão principal enquanto um card está na tela
                        return; // Para a busca e espera a ação do usuário
                    }
                } catch (error) {
                    console.error(`Erro ao verificar ${channelName}:`, error);
                }
                currentIndex++;
            }

            // Se chegou ao final da lista
            statusMessage.textContent = 'Verificação concluída! Nenhum outro canal online encontrado.';
            nextChannelBtn.innerHTML = 'Começar de Novo';
            nextChannelBtn.style.backgroundColor = '#ffae42';
            channelDisplay.innerHTML = '';
            channelDisplay.appendChild(nextChannelBtn);
            nextChannelBtn.disabled = false;
        }

        function createLauncherElement(channelName) {
            channelDisplay.innerHTML = ''; // Limpa o botão de busca
            const launcherWrapper = document.createElement('div');
            launcherWrapper.className = 'channel-card';
            launcherWrapper.innerHTML = `
                <span class="channel-name">${channelName}</span>
                <button class="launch-btn">Abrir e Próximo</button>`;
            launcherWrapper.querySelector('.launch-btn').onclick = () => {
                window.open(`https://kick.com/${channelName}/chatroom`, `_blank`, 'width=400,height=600,resizable=yes,scrollbars=yes');
                addChannelToOpened(channelName);
                updateCompletedCounter();
                currentIndex++;
                findNextOnline(); // Retoma a busca
            };
            channelDisplay.appendChild(launcherWrapper);
        }

        nextChannelBtn.addEventListener('click', () => {
            if (nextChannelBtn.textContent === 'Começar de Novo') {
                localStorage.removeItem('openedKickChannels');
                currentIndex = 0;
                updateCompletedCounter();
                nextChannelBtn.style.backgroundColor = '#7f7fff';
            }
            findNextOnline();
        });

        function loadMasterList() {
            masterChannelList = JSON.parse(localStorage.getItem('kickLaunchers')) || [];
            updateCompletedCounter();
            statusMessage.textContent = `${masterChannelList.length} canais na sua lista. Pronto para começar.`;
        }
        
        function addNewChannel() {
            const streamerName = streamerInput.value.trim().toLowerCase();
            if (!streamerName) return;
            if (masterChannelList.includes(streamerName)) return;
            masterChannelList.push(streamerName);
            localStorage.setItem('kickLaunchers', JSON.stringify(masterChannelList));
            streamerInput.value = '';
            loadMasterList();
        }

        addChatBtn.addEventListener('click', addNewChannel);
        streamerInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') addNewChannel();
        });

        document.addEventListener('DOMContentLoaded', loadMasterList);
    </script>
</body>
</html>
